<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="theme-color" content="#f5f0eb" id="metaTheme">
  <title>Teen Summit â€” Business Basics</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,400;9..40,500;9..40,700;9..40,800&family=Bricolage+Grotesque:opsz,wght@12..96,700;12..96,800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       FIREBASE â€” Replace with YOUR config from console.firebase.google.com
       1. Create a project  â†’  Build â†’ Realtime Database â†’ Create
       2. Set rules to:  { "rules": { ".read": true, ".write": true } }
       3. Copy your config below
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-app.js";
    import { getDatabase, ref, set, get, onValue, runTransaction }
      from "https://www.gstatic.com/firebasejs/11.3.0/firebase-database.js";

    // â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    // â”‚  PASTE YOUR FIREBASE CONFIG HERE                â”‚
    // â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    const firebaseConfig = {
      apiKey:            "YOUR_API_KEY",
      authDomain:        "YOUR_PROJECT.firebaseapp.com",
      databaseURL:       "https://YOUR_PROJECT-default-rtdb.firebaseio.com",
      projectId:         "YOUR_PROJECT",
      storageBucket:     "YOUR_PROJECT.appspot.com",
      messagingSenderId: "000000000000",
      appId:             "1:000000000000:web:abcdef1234567890"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    // Expose to global scope for the quiz logic
    window._fb = { db, ref, set, get, onValue, runTransaction };
    window.dispatchEvent(new Event("fb-ready"));
  </script>

  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    /* â•â•â•â•â•â•â• LIGHT THEME â•â•â•â•â•â•â• */
    :root {
      --bg-primary: #f5f0eb;
      --bg-secondary: #ffffff;
      --bg-tertiary: #ede7e0;
      --text-primary: #1a1612;
      --text-secondary: #6b5e52;
      --text-muted: #9a8d82;
      --border: #ddd5cc;
      --accent: #e85d2a;
      --accent-soft: #fdeee8;
      --accent-hover: #d14e1f;
      --correct: #1a9956;
      --wrong: #d93636;
      --warn: #c48a12;
      --chart-a: #e85d2a;
      --chart-b: #3b7ddd;
      --chart-c: #1a9956;
      --chart-d: #9b59b6;
      --selected-bg: #1a1612;
      --selected-text: #ffffff;
      --selected-badge: #ffffff;
      --progress-track: #ddd5cc;
      --progress-fill: #e85d2a;
      --shadow-sm: 0 1px 3px rgba(26,22,18,0.06);
      --shadow-md: 0 4px 14px rgba(26,22,18,0.09);
      --radius: 16px;
      --radius-sm: 12px;
      --radius-xs: 6px;
      --transition: 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }

    /* â•â•â•â•â•â•â• DARK THEME â•â•â•â•â•â•â• */
    [data-theme="dark"] {
      --bg-primary: #0e0e0e;
      --bg-secondary: #191919;
      --bg-tertiary: #232323;
      --text-primary: #f0ece8;
      --text-secondary: #a09890;
      --text-muted: #605850;
      --border: #2c2c2c;
      --accent: #f07040;
      --accent-soft: #2c1d15;
      --accent-hover: #ff8a60;
      --correct: #2dd47a;
      --wrong: #f05050;
      --warn: #e8a830;
      --chart-a: #f07040;
      --chart-b: #5a9eff;
      --chart-c: #2dd47a;
      --chart-d: #c084fc;
      --selected-bg: #f07040;
      --selected-text: #0e0e0e;
      --selected-badge: #0e0e0e;
      --progress-track: #2c2c2c;
      --progress-fill: #f07040;
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.4);
      --shadow-md: 0 4px 14px rgba(0,0,0,0.5);
    }

    html { scroll-behavior: smooth; -webkit-tap-highlight-color: transparent; }

    body {
      font-family: 'DM Sans', system-ui, -apple-system, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      min-height: 100dvh;
      transition: background var(--transition), color var(--transition);
      -webkit-font-smoothing: antialiased;
      overflow-x: hidden;
    }

    /* â”€â”€â”€ Header â”€â”€â”€ */
    header {
      position: sticky; top: 0; z-index: 20;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
      transition: background var(--transition), border-color var(--transition);
    }
    .header-inner {
      max-width: 1080px;
      margin: 0 auto;
      padding: 12px 16px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .logo {
      width: 40px; height: 40px;
      border-radius: 12px;
      background: var(--accent);
      color: #fff;
      display: grid;
      place-items: center;
      font-family: 'Bricolage Grotesque', sans-serif;
      font-weight: 800;
      font-size: 15px;
      flex-shrink: 0;
    }
    .header-text { flex: 1; min-width: 0; }
    .header-title {
      font-family: 'Bricolage Grotesque', sans-serif;
      font-size: 1rem;
      font-weight: 800;
      line-height: 1.2;
      letter-spacing: -0.3px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .header-sub {
      font-size: 0.72rem;
      color: var(--text-secondary);
      margin-top: 1px;
    }
    .header-actions { display: flex; gap: 8px; align-items: center; flex-shrink: 0; }
    .host-badge {
      padding: 5px 12px;
      border-radius: 100px;
      background: var(--bg-tertiary);
      color: var(--text-secondary);
      font-size: 0.72rem;
      font-weight: 600;
      white-space: nowrap;
      transition: background var(--transition);
    }
    .icon-btn {
      width: 38px; height: 38px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--bg-tertiary);
      color: var(--text-primary);
      cursor: pointer;
      display: grid;
      place-items: center;
      font-size: 16px;
      transition: all var(--transition);
      flex-shrink: 0;
      -webkit-appearance: none;
    }
    .icon-btn:hover {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
    }
    .icon-btn:active { transform: scale(0.92); }

    /* â”€â”€â”€ Main â”€â”€â”€ */
    main {
      max-width: 1080px;
      margin: 0 auto;
      padding: 16px 16px calc(16px + var(--safe-bottom));
    }
    .layout {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    @media (min-width: 860px) {
      main { padding: 24px 20px 40px; }
      .layout {
        display: grid;
        grid-template-columns: 1fr 360px;
        gap: 20px;
        align-items: start;
      }
    }
    @media (min-width: 1060px) {
      .layout { grid-template-columns: 1fr 400px; }
    }

    /* â”€â”€â”€ Card â”€â”€â”€ */
    .card {
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: var(--bg-secondary);
      padding: 20px;
      box-shadow: var(--shadow-sm);
      transition: background var(--transition), border-color var(--transition);
    }
    @media (min-width: 860px) {
      .card { padding: 24px; }
    }

    /* â”€â”€â”€ Question Card â”€â”€â”€ */
    .q-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 12px; }
    .q-label {
      font-size: 0.68rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      color: var(--accent);
    }
    .q-text {
      font-family: 'Bricolage Grotesque', sans-serif;
      font-size: 1.15rem;
      font-weight: 800;
      line-height: 1.3;
      letter-spacing: -0.2px;
      margin-top: 6px;
    }
    @media (min-width: 560px) { .q-text { font-size: 1.3rem; } }

    .score-box { text-align: right; flex-shrink: 0; }
    .score-label {
      font-size: 0.6rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      color: var(--text-muted);
    }
    .score-value {
      font-family: 'Bricolage Grotesque', sans-serif;
      font-size: 1.6rem;
      font-weight: 800;
      line-height: 1;
      letter-spacing: -1px;
    }

    /* â”€â”€â”€ Answers â”€â”€â”€ */
    .answers-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
      margin-top: 18px;
    }
    @media (min-width: 560px) {
      .answers-grid { grid-template-columns: 1fr 1fr; gap: 12px; }
    }

    .answer-btn {
      text-align: left;
      border-radius: var(--radius-sm);
      border: 2px solid var(--border);
      background: var(--bg-secondary);
      padding: 14px;
      cursor: pointer;
      transition: all 0.18s ease;
      display: flex;
      align-items: center;
      gap: 12px;
      font-family: inherit;
      color: var(--text-primary);
      -webkit-appearance: none;
      min-height: 56px;
      touch-action: manipulation;
    }
    .answer-btn:hover {
      border-color: var(--accent);
      box-shadow: var(--shadow-md);
      transform: translateY(-1px);
    }
    .answer-btn:active { transform: scale(0.98); }
    .answer-btn.selected {
      background: var(--selected-bg);
      border-color: var(--selected-bg);
      color: var(--selected-text);
      box-shadow: var(--shadow-md);
    }
    .answer-btn.selected .answer-badge {
      background: var(--selected-badge) !important;
      color: var(--selected-bg) !important;
    }
    .answer-btn.selected .answer-hint { opacity: 0.45; }

    .answer-badge {
      width: 34px; height: 34px;
      border-radius: 10px;
      display: grid;
      place-items: center;
      font-weight: 800;
      font-size: 0.85rem;
      flex-shrink: 0;
    }
    .badge-a { background: rgba(232,93,42,0.13); color: var(--chart-a); }
    .badge-b { background: rgba(59,125,221,0.13); color: var(--chart-b); }
    .badge-c { background: rgba(26,153,86,0.13); color: var(--chart-c); }
    .badge-d { background: rgba(155,89,182,0.13); color: var(--chart-d); }

    .answer-content { flex: 1; min-width: 0; }
    .answer-text { font-weight: 600; line-height: 1.35; font-size: 0.88rem; }
    .answer-hint { font-size: 0.68rem; color: var(--text-muted); margin-top: 2px; }

    /* â”€â”€â”€ Step Dots â”€â”€â”€ */
    .step-dots {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-top: 18px;
      padding: 4px 0;
    }
    .step-dot {
      width: 10px; height: 10px;
      border-radius: 100px;
      background: var(--progress-track);
      transition: all 0.3s ease;
      cursor: pointer;
      border: none;
      -webkit-appearance: none;
      touch-action: manipulation;
      padding: 0;
    }
    .step-dot.active { width: 28px; background: var(--accent); }
    .step-dot.answered { background: var(--correct); }
    .step-dot.answered.active { background: var(--accent); width: 28px; }

    /* â”€â”€â”€ Footer â”€â”€â”€ */
    .q-footer {
      margin-top: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    @media (min-width: 480px) {
      .q-footer { flex-direction: row; align-items: center; justify-content: space-between; }
    }
    .feedback {
      font-size: 0.85rem;
      font-weight: 700;
      min-height: 22px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .feedback.correct { color: var(--correct); }
    .feedback.wrong   { color: var(--wrong); }
    .feedback.warn    { color: var(--warn); }

    .nav-btns { display: flex; gap: 8px; }
    .nav-btn {
      flex: 1;
      padding: 12px 16px;
      border-radius: var(--radius-sm);
      border: 2px solid var(--border);
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-weight: 700;
      font-size: 0.88rem;
      cursor: pointer;
      transition: all 0.18s ease;
      font-family: inherit;
      text-align: center;
      touch-action: manipulation;
      -webkit-appearance: none;
    }
    @media (min-width: 480px) { .nav-btn { flex: none; padding: 10px 20px; } }
    .nav-btn:active:not(:disabled) { transform: scale(0.96); }
    .nav-btn:disabled { opacity: 0.3; cursor: not-allowed; }
    .nav-btn.primary {
      background: var(--accent);
      border-color: var(--accent);
      color: #fff;
    }
    .nav-btn.primary:hover:not(:disabled) { background: var(--accent-hover); border-color: var(--accent-hover); }

    /* â”€â”€â”€ Sidebar â”€â”€â”€ */
    .sidebar-stack { display: flex; flex-direction: column; gap: 16px; }

    /* â”€â”€â”€ Live Chart â”€â”€â”€ */
    .chart-header { display: flex; justify-content: space-between; align-items: center; gap: 8px; flex-wrap: wrap; }
    .chart-label {
      font-size: 0.62rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      color: var(--text-muted);
    }
    .chart-title {
      font-family: 'Bricolage Grotesque', sans-serif;
      font-size: 1rem;
      font-weight: 800;
      margin-top: 1px;
    }
    .live-dot {
      display: inline-block;
      width: 7px; height: 7px;
      border-radius: 50%;
      background: var(--correct);
      margin-right: 4px;
      animation: pulse-dot 2s ease infinite;
    }
    @keyframes pulse-dot {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.4; transform: scale(0.8); }
    }
    .live-tag {
      display: inline-flex;
      align-items: center;
      font-size: 0.68rem;
      font-weight: 700;
      color: var(--correct);
      padding: 3px 10px 3px 8px;
      background: rgba(26,153,86,0.1);
      border-radius: 100px;
    }
    [data-theme="dark"] .live-tag { background: rgba(45,212,122,0.12); }
    .chart-wrap { margin-top: 14px; }

    /* Vote count chips under chart */
    .vote-chips {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-top: 12px;
    }
    .vote-chip {
      display: flex;
      align-items: center;
      gap: 5px;
      padding: 4px 10px;
      border-radius: 100px;
      background: var(--bg-tertiary);
      font-size: 0.72rem;
      font-weight: 700;
      color: var(--text-secondary);
      transition: background var(--transition);
    }
    .vote-chip-dot {
      width: 8px; height: 8px;
      border-radius: 50%;
    }
    .total-votes {
      margin-top: 10px;
      font-size: 0.72rem;
      color: var(--text-muted);
    }

    /* â”€â”€â”€ Progress â”€â”€â”€ */
    .progress-card {
      border-radius: var(--radius-sm);
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      padding: 16px;
      transition: background var(--transition), border-color var(--transition);
    }
    .progress-label {
      font-size: 0.62rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      color: var(--text-muted);
    }
    .progress-track {
      margin-top: 8px;
      height: 6px;
      border-radius: 100px;
      background: var(--progress-track);
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      width: 0%;
      border-radius: 100px;
      background: var(--progress-fill);
      transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .progress-info {
      margin-top: 8px;
      font-size: 0.82rem;
      color: var(--text-secondary);
      display: flex;
      justify-content: space-between;
    }
    .progress-info strong { color: var(--text-primary); font-weight: 700; }
    .progress-meta {
      margin-top: 6px;
      font-size: 0.68rem;
      color: var(--text-muted);
    }

    /* â”€â”€â”€ Finish â”€â”€â”€ */
    .finish-card {
      border: 2px solid var(--accent) !important;
      background: var(--accent-soft) !important;
      animation: pop-in 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    .finish-inner { display: flex; justify-content: space-between; align-items: center; gap: 16px; }
    .finish-title { font-family: 'Bricolage Grotesque', sans-serif; font-size: 1.2rem; font-weight: 800; }
    .finish-sub { color: var(--text-secondary); font-size: 0.82rem; margin-top: 2px; }
    .finish-score {
      font-family: 'Bricolage Grotesque', sans-serif;
      font-size: 2rem;
      font-weight: 800;
      color: var(--accent);
      letter-spacing: -1px;
      line-height: 1;
    }
    .finish-score-label {
      font-size: 0.6rem; font-weight: 700; text-transform: uppercase;
      letter-spacing: 1.5px; color: var(--text-muted); text-align: right;
    }

    @keyframes pop-in {
      0% { transform: scale(0.92); opacity: 0; }
      100% { transform: scale(1); opacity: 1; }
    }

    /* â”€â”€â”€ Setup banner â”€â”€â”€ */
    .setup-banner {
      margin-bottom: 16px;
      padding: 14px 18px;
      border-radius: var(--radius-sm);
      background: var(--warn);
      color: #fff;
      font-size: 0.82rem;
      font-weight: 600;
      line-height: 1.5;
    }
    .setup-banner a { color: #fff; text-decoration: underline; }
    .setup-banner code {
      background: rgba(0,0,0,0.15);
      padding: 1px 5px;
      border-radius: 4px;
      font-size: 0.78rem;
    }

    /* â”€â”€â”€ Confetti â”€â”€â”€ */
    .confetti-container {
      position: fixed; inset: 0;
      pointer-events: none; z-index: 100; overflow: hidden;
    }
    .confetti-piece {
      position: absolute;
      top: -20px;
      animation: confetti-fall 3s ease-in forwards;
    }
    @keyframes confetti-fall {
      0%   { transform: translateY(0) rotate(0deg); opacity: 1; }
      100% { transform: translateY(110vh) rotate(720deg); opacity: 0; }
    }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 5px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }

    /* Hide on very small widths */
    @media (max-width: 400px) {
      .host-badge { display: none; }
      .header-title { font-size: 0.9rem; }
    }
  </style>
</head>
<body>

  <header>
    <div class="header-inner">
      <div class="logo">TS</div>
      <div class="header-text">
        <div class="header-title">Teen Summit â€” Business Basics</div>
        <div class="header-sub">5 questions Â· Live shared results</div>
      </div>
      <div class="header-actions">
        <span id="hostBadge" class="host-badge">Host: â€”</span>
        <button id="themeBtn" class="icon-btn" title="Toggle theme" aria-label="Toggle theme">â˜€ï¸</button>
      </div>
    </div>
  </header>

  <main>
    <div id="setupBanner" class="setup-banner" style="display:none;">
      âš ï¸ Firebase not configured. Replace <code>firebaseConfig</code> in this file with your
      <a href="https://console.firebase.google.com" target="_blank">Firebase project</a> credentials.
      The quiz still works locally â€” votes just won't sync between devices.
    </div>

    <div class="layout">
      <!-- Question Panel -->
      <div class="card" id="questionCard">
        <div class="q-header">
          <div style="flex:1; min-width:0;">
            <div class="q-label">Question <span id="qIndex">1</span> of <span id="qTotal">5</span></div>
            <h2 id="qText" class="q-text">â€”</h2>
          </div>
          <div class="score-box">
            <div class="score-label">Score</div>
            <div class="score-value"><span id="score">0</span>/<span id="scoreTotal">5</span></div>
          </div>
        </div>

        <div id="answersGrid" class="answers-grid"></div>
        <div class="step-dots" id="stepDots"></div>

        <div class="q-footer">
          <div id="feedback" class="feedback"></div>
          <div class="nav-btns">
            <button id="prevBtn" class="nav-btn" disabled>â† Back</button>
            <button id="nextBtn" class="nav-btn primary" disabled>Next â†’</button>
          </div>
        </div>
      </div>

      <!-- Sidebar -->
      <div class="sidebar-stack">
        <div class="card">
          <div class="chart-header">
            <div>
              <div class="chart-label">Live Results</div>
              <div class="chart-title">Answer Distribution</div>
            </div>
            <span class="live-tag" id="liveTag"><span class="live-dot"></span>Live</span>
          </div>
          <div class="chart-wrap">
            <canvas id="countsChart" height="190"></canvas>
          </div>
          <div class="vote-chips" id="voteChips"></div>
          <div class="total-votes" id="totalVotesLabel"></div>
        </div>

        <div class="progress-card">
          <div class="progress-label">Your Progress</div>
          <div class="progress-track">
            <div id="progressBar" class="progress-fill"></div>
          </div>
          <div class="progress-info">
            <span>Answered: <strong><span id="answeredCount">0</span></strong> / <strong><span id="answeredTotal">5</span></strong></span>
            <span><strong id="pctLabel">0%</strong></span>
          </div>
          <div class="progress-meta">
            ID: <span id="clientBadge"></span> Â· Tab: <span id="tabBadge"></span>
          </div>
        </div>

        <div id="endSection" class="card finish-card" style="display:none;">
          <div class="finish-inner">
            <div>
              <div class="finish-title">ğŸ‰ Finished!</div>
              <div class="finish-sub">Great work â€” quiz complete.</div>
            </div>
            <div>
              <div class="finish-score-label">Final Score</div>
              <div class="finish-score"><span id="finalScore">0</span>/<span id="finalTotal">5</span></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       THEME
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    const themeBtn = document.getElementById('themeBtn');
    const metaTheme = document.getElementById('metaTheme');
    function applyTheme(dark) {
      if (dark) {
        document.documentElement.setAttribute('data-theme', 'dark');
        themeBtn.textContent = 'ğŸŒ™';
        metaTheme.content = '#0e0e0e';
      } else {
        document.documentElement.removeAttribute('data-theme');
        themeBtn.textContent = 'â˜€ï¸';
        metaTheme.content = '#f5f0eb';
      }
      localStorage.setItem('ts_theme', dark ? 'dark' : 'light');
      if (chart) updateChartTheme();
    }
    if (localStorage.getItem('ts_theme') === 'dark') applyTheme(true);
    themeBtn.addEventListener('click', () => {
      applyTheme(document.documentElement.getAttribute('data-theme') !== 'dark');
    });

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       QUIZ DATA
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    const QUIZ = {
      questions: [
        { text: "What is a business?", choices: ["A way to trade goods or services for money (or value)","A school subject you only study in college","A hobby you do for free","A job where you only do chores"], correctIndex: 0 },
        { text: "Which is the BEST example of a business for a middle schooler?", choices: ["Mowing lawns for neighbors and charging a price","Doing homework for free every day","Watching videos after school","Borrowing money and never paying it back"], correctIndex: 0 },
        { text: "What does \u201Cprofit\u201D mean?", choices: ["Money left after costs are paid","All the money you earn before paying costs","A business license","A fancy logo"], correctIndex: 0 },
        { text: "Which is a smart FIRST step to start a business?", choices: ["Find a problem to solve or a need people have","Buy expensive supplies right away","Skip asking customers what they want","Set random prices each day"], correctIndex: 0 },
        { text: "A business is different from a job because\u2026", choices: ["A business owner finds customers and sets prices","A job never pays money","A business is only online","A job means you can\u2019t learn skills"], correctIndex: 0 }
      ]
    };

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       STATE & IDs
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    const $ = (id) => document.getElementById(id);
    const pageUrl = new URL(window.location.href);
    const host = (pageUrl.searchParams.get("host") || "teensummit").trim();

    function ensureId(storage, key) {
      let v = storage.getItem(key);
      if (!v) { v = crypto.randomUUID ? crypto.randomUUID() : String(Math.random()).slice(2) + Date.now(); storage.setItem(key, v); }
      return v;
    }
    const clientId = ensureId(localStorage, "teen_summit_client_id");
    const tabId    = ensureId(sessionStorage, "teen_summit_tab_id");

    $("hostBadge").textContent  = "Host: " + host;
    $("clientBadge").textContent = clientId.slice(0, 8);
    $("tabBadge").textContent    = tabId.slice(0, 8);

    let currentQ  = 0;
    let answers   = Array.from({ length: QUIZ.questions.length }, () => null);
    let score     = 0;
    let chart     = null;
    let fbReady   = false;
    let unsubscribe = null;  // Firebase listener cleanup

    const CHART_VARS   = ['--chart-a','--chart-b','--chart-c','--chart-d'];
    const BADGE_CLASSES = ['badge-a','badge-b','badge-c','badge-d'];
    const BADGE_LABELS  = ['A','B','C','D'];

    function css(v) { return getComputedStyle(document.documentElement).getPropertyValue(v).trim(); }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       FIREBASE BACKEND (or local fallback)
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    // Local fallback counts when Firebase isn't configured
    let localCounts = QUIZ.questions.map(q => Array(q.choices.length).fill(0));
    let localVoted  = new Set();

    // Returns the DB path for a question's votes
    function dbPath(q) {
      return "quiz/" + host + "/q" + q;
    }

    async function fbVote(qIdx, choice) {
      if (!fbReady) {
        // Local fallback
        const key = qIdx + "-" + tabId;
        if (localVoted.has(key)) return { counts: localCounts[qIdx], alreadyVoted: true };
        localCounts[qIdx][choice]++;
        localVoted.add(key);
        return { counts: localCounts[qIdx], alreadyVoted: false };
      }

      const { db, ref, runTransaction, get } = window._fb;
      const votedKey = "quiz/" + host + "/voted/" + tabId + "/q" + qIdx;

      // Check if already voted
      const snap = await get(ref(db, votedKey));
      if (snap.exists()) {
        const cSnap = await get(ref(db, dbPath(qIdx)));
        return { counts: cSnap.val() || Array(QUIZ.questions[qIdx].choices.length).fill(0), alreadyVoted: true };
      }

      // Transaction: increment the chosen answer
      const countRef = ref(db, dbPath(qIdx));
      await runTransaction(countRef, (current) => {
        if (!current) current = Array(QUIZ.questions[qIdx].choices.length).fill(0);
        current[choice] = (current[choice] || 0) + 1;
        return current;
      });

      // Mark as voted
      await window._fb.set(ref(db, votedKey), true);

      const updatedSnap = await get(countRef);
      return { counts: updatedSnap.val(), alreadyVoted: false };
    }

    async function fbGetCounts(qIdx) {
      if (!fbReady) return localCounts[qIdx];
      const { db, ref, get } = window._fb;
      const snap = await get(ref(db, dbPath(qIdx)));
      return snap.val() || Array(QUIZ.questions[qIdx].choices.length).fill(0);
    }

    // Real-time listener for a specific question
    function fbListen(qIdx, callback) {
      if (unsubscribe) { unsubscribe(); unsubscribe = null; }
      if (!fbReady) return;
      const { db, ref, onValue } = window._fb;
      const unsub = onValue(ref(db, dbPath(qIdx)), (snap) => {
        const counts = snap.val() || Array(QUIZ.questions[qIdx].choices.length).fill(0);
        callback(counts);
      });
      unsubscribe = () => unsub(); // onValue returns an unsubscribe function
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SCORING & PROGRESS
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    function computeScore() {
      score = 0;
      QUIZ.questions.forEach((q, i) => { if (answers[i] === q.correctIndex) score++; });
    }
    function answeredCount() { return answers.filter(v => v !== null).length; }

    function updateProgress() {
      const done  = answeredCount();
      const total = QUIZ.questions.length;
      $("answeredCount").textContent = done;
      $("answeredTotal").textContent = total;
      const pct = Math.round((done / total) * 100);
      $("progressBar").style.width = pct + "%";
      $("pctLabel").textContent = pct + "%";

      if (done === total) {
        $("endSection").style.display = '';
        $("finalScore").textContent = score;
        $("finalTotal").textContent = total;
        fireConfetti();
      } else {
        $("endSection").style.display = 'none';
      }
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       STEP DOTS
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    function renderStepDots() {
      const el = $("stepDots");
      el.innerHTML = "";
      QUIZ.questions.forEach((_, i) => {
        const dot = document.createElement("button");
        dot.className = "step-dot";
        if (i === currentQ) dot.classList.add("active");
        if (answers[i] !== null) dot.classList.add("answered");
        dot.setAttribute("aria-label", "Question " + (i + 1));
        dot.addEventListener("click", async () => { currentQ = i; await render(); });
        el.appendChild(dot);
      });
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       CHART
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    function chartColors() { return CHART_VARS.map(css); }

    function updateChartTheme() {
      if (!chart) return;
      const c = chartColors();
      chart.data.datasets[0].backgroundColor = c;
      chart.data.datasets[0].borderColor = c;
      chart.options.scales.x.ticks.color = css('--text-secondary');
      chart.options.scales.y.ticks.color = css('--text-secondary');
      chart.options.scales.y.grid.color  = css('--border');
      chart.update('none');
    }

    function updateChart(counts) {
      const q = QUIZ.questions[currentQ];
      const labels = q.choices.map((_, i) => BADGE_LABELS[i]);
      const colors = chartColors();

      if (!chart) {
        chart = new Chart($("countsChart").getContext("2d"), {
          type: "bar",
          data: {
            labels,
            datasets: [{ data: counts, backgroundColor: colors, borderColor: colors, borderWidth: 0, borderRadius: 8, borderSkipped: false, barPercentage: 0.6, categoryPercentage: 0.7 }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            animation: { duration: 400, easing: 'easeOutQuart' },
            plugins: { legend: { display: false }, tooltip: { backgroundColor: css('--bg-secondary'), titleColor: css('--text-primary'), bodyColor: css('--text-primary'), borderColor: css('--border'), borderWidth: 1, cornerRadius: 8, padding: 10, displayColors: true, callbacks: { label: (ctx) => " " + ctx.parsed.y + " vote" + (ctx.parsed.y !== 1 ? "s" : "") } } },
            scales: {
              y: { beginAtZero: true, ticks: { precision: 0, color: css('--text-secondary'), font: { size: 11, weight: '600' } }, grid: { color: css('--border'), drawBorder: false }, border: { display: false } },
              x: { ticks: { color: css('--text-secondary'), font: { size: 13, weight: '700' } }, grid: { display: false }, border: { display: false } }
            }
          }
        });
      } else {
        chart.data.labels = labels;
        chart.data.datasets[0].data = counts;
        chart.data.datasets[0].backgroundColor = colors;
        chart.data.datasets[0].borderColor = colors;
        chart.update();
      }

      // Vote chips
      const chips = $("voteChips");
      const total = counts.reduce((a, b) => a + b, 0);
      chips.innerHTML = "";
      counts.forEach((c, i) => {
        const chip = document.createElement("span");
        chip.className = "vote-chip";
        chip.innerHTML = '<span class="vote-chip-dot" style="background:' + colors[i] + '"></span>' + BADGE_LABELS[i] + ': ' + c;
        chips.appendChild(chip);
      });
      $("totalVotesLabel").textContent = total + " total vote" + (total !== 1 ? "s" : "") + " on this question";
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       CONFETTI
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    let confettiFired = false;
    function fireConfetti() {
      if (confettiFired) return;
      confettiFired = true;
      const container = document.createElement('div');
      container.className = 'confetti-container';
      document.body.appendChild(container);
      const pal = ['#e85d2a','#3b7ddd','#1a9956','#9b59b6','#f1c40f','#e74c3c'];
      for (let i = 0; i < 55; i++) {
        const p = document.createElement('div');
        p.className = 'confetti-piece';
        p.style.left = Math.random() * 100 + '%';
        p.style.background = pal[Math.floor(Math.random() * pal.length)];
        p.style.animationDelay = Math.random() * 1.5 + 's';
        p.style.animationDuration = (2 + Math.random() * 2) + 's';
        p.style.borderRadius = Math.random() > 0.5 ? '50%' : '2px';
        const s = 6 + Math.random() * 8;
        p.style.width = s + 'px'; p.style.height = s + 'px';
        container.appendChild(p);
      }
      setTimeout(() => container.remove(), 5000);
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       RENDER
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    async function render() {
      const q = QUIZ.questions[currentQ];
      $("qIndex").textContent = currentQ + 1;
      $("qTotal").textContent = QUIZ.questions.length;
      $("qText").textContent  = q.text;

      computeScore();
      $("score").textContent      = score;
      $("scoreTotal").textContent = QUIZ.questions.length;

      $("prevBtn").disabled   = currentQ === 0;
      $("nextBtn").textContent = currentQ === QUIZ.questions.length - 1 ? "Finish âœ“" : "Next â†’";
      $("nextBtn").disabled   = answers[currentQ] === null;

      $("feedback").textContent = "";
      $("feedback").className   = "feedback";

      // Answer buttons
      const grid = $("answersGrid");
      grid.innerHTML = "";
      q.choices.forEach((text, idx) => {
        const sel = answers[currentQ] === idx;
        const btn = document.createElement("button");
        btn.className = "answer-btn" + (sel ? " selected" : "");
        btn.innerHTML =
          '<div class="answer-badge ' + (sel ? '' : BADGE_CLASSES[idx]) + '">' + BADGE_LABELS[idx] + '</div>' +
          '<div class="answer-content"><div class="answer-text">' + text + '</div>' +
          '<div class="answer-hint">' + (sel ? 'Selected' : 'Tap to select') + '</div></div>';
        btn.addEventListener("click", () => selectAnswer(idx));
        grid.appendChild(btn);
      });

      renderStepDots();
      updateProgress();

      // Load counts & set up real-time listener
      try {
        const counts = await fbGetCounts(currentQ);
        updateChart(counts);
        // Attach real-time listener
        fbListen(currentQ, (liveCounts) => { updateChart(liveCounts); });
      } catch {
        updateChart(Array(q.choices.length).fill(0));
      }
    }

    async function selectAnswer(choiceIdx) {
      const q = QUIZ.questions[currentQ];
      const wasUnanswered = answers[currentQ] === null;
      answers[currentQ] = choiceIdx;

      if (wasUnanswered) {
        try {
          const result = await fbVote(currentQ, choiceIdx);
          if (result.alreadyVoted) {
            $("feedback").textContent = "\u26A0\uFE0F Already voted on this question.";
            $("feedback").className = "feedback warn";
          } else {
            const ok = choiceIdx === q.correctIndex;
            $("feedback").textContent = ok ? "\u2705 Correct!" : "\u274C Not quite.";
            $("feedback").className = "feedback " + (ok ? "correct" : "wrong");
          }
        } catch {
          $("feedback").textContent = "\u26A0\uFE0F Vote failed â€” check Firebase config.";
          $("feedback").className = "feedback warn";
        }
      }
      await render();
    }

    $("prevBtn").addEventListener("click", async () => { currentQ = Math.max(0, currentQ - 1); await render(); });
    $("nextBtn").addEventListener("click", async () => {
      if (answers[currentQ] === null) return;
      if (currentQ < QUIZ.questions.length - 1) currentQ++;
      await render();
    });

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       BOOT â€” wait for Firebase or fallback
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    function boot() {
      if (window._fb) {
        fbReady = true;
        $("liveTag").style.display = '';
      } else {
        fbReady = false;
        $("setupBanner").style.display = '';
        $("liveTag").querySelector('.live-dot').style.background = css('--warn');
      }
      render().catch(() => {});
    }

    // Firebase module loads async â€” wait for it or timeout
    if (window._fb) {
      boot();
    } else {
      const onReady = () => { boot(); window.removeEventListener('fb-ready', onReady); };
      window.addEventListener('fb-ready', onReady);
      // Fallback after 3s if Firebase fails to load
      setTimeout(() => { if (!fbReady) boot(); }, 3000);
    }
  </script>

</body>
</html>