<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Teen Summit — Business Basics</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body class="min-h-screen bg-slate-50 text-slate-900">
  <header class="sticky top-0 z-20 border-b bg-white/90 backdrop-blur">
    <div class="mx-auto max-w-5xl px-4 py-3 flex items-center gap-3">
      <div class="h-10 w-10 rounded-2xl bg-slate-900 text-white grid place-items-center font-black">TS</div>
      <div class="flex-1">
        <h1 class="text-lg sm:text-xl font-semibold leading-tight">Teen Summit — Business Basics</h1>
        <p class="text-xs sm:text-sm text-slate-600">Answer 5 questions • Shared counts update automatically</p>
      </div>
      <span id="hostBadge" class="hidden sm:inline px-3 py-1 rounded-full bg-slate-100 text-slate-700 text-sm font-medium">Host: —</span>
    </div>
  </header>

  <main class="mx-auto max-w-5xl px-4 py-6">
    <section class="grid lg:grid-cols-5 gap-4">
      <div class="lg:col-span-3 rounded-2xl border bg-white p-5 shadow-sm">
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="text-xs uppercase tracking-wide text-slate-500">Question <span id="qIndex">1</span> of <span id="qTotal">5</span></div>
            <h2 id="qText" class="mt-1 text-xl font-bold leading-snug">—</h2>
          </div>
          <div class="text-right">
            <div class="text-xs uppercase tracking-wide text-slate-500">Score</div>
            <div class="text-2xl font-black"><span id="score">0</span>/<span id="scoreTotal">5</span></div>
          </div>
        </div>

        <div id="answersGrid" class="mt-5 grid sm:grid-cols-2 gap-3"></div>

        <div class="mt-5 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
          <div id="feedback" class="text-sm font-semibold"></div>
          <div class="flex gap-2">
            <button id="prevBtn" class="px-4 py-2 rounded-xl border bg-white hover:bg-slate-50 font-semibold disabled:opacity-50" disabled>Back</button>
            <button id="nextBtn" class="px-4 py-2 rounded-xl bg-slate-900 text-white hover:bg-slate-800 font-semibold disabled:opacity-50" disabled>Next</button>
          </div>
        </div>
      </div>

      <div class="lg:col-span-2 rounded-2xl border bg-white p-5 shadow-sm">
        <div class="flex items-center justify-between">
          <div>
            <div class="text-xs uppercase tracking-wide text-slate-500">Shared Answer Counts</div>
            <h3 class="text-base font-semibold">Teen Summit Board</h3>
          </div>
          <label class="flex items-center gap-2 text-xs font-semibold">
            <input id="pollToggle" type="checkbox" class="accent-slate-900" checked />
            Auto-update
          </label>
        </div>

        <div class="mt-4">
          <canvas id="countsChart" height="180"></canvas>
        </div>

        <div class="mt-4 rounded-2xl bg-slate-50 border p-4">
          <div class="text-xs uppercase tracking-wide text-slate-500">Progress</div>
          <div class="mt-2 h-3 w-full rounded-full bg-slate-200 overflow-hidden">
            <div id="progressBar" class="h-full bg-slate-900 w-0"></div>
          </div>
          <div class="mt-2 text-sm text-slate-700">
            Answered: <span id="answeredCount" class="font-semibold">0</span>/<span id="answeredTotal" class="font-semibold">5</span>
          </div>
          <div class="mt-2 text-xs text-slate-500">
            Your ID: <span id="clientBadge" class="font-mono"></span> • Tab: <span id="tabBadge" class="font-mono"></span>
          </div>
        </div>

        <div id="endSection" class="hidden mt-4 rounded-2xl border bg-white p-5 shadow-sm">
          <div class="flex items-center justify-between">
            <div>
              <h3 class="text-xl font-bold">Finished!</h3>
              <p class="text-slate-600">Nice work.</p>
            </div>
            <div class="text-right">
              <div class="text-xs uppercase tracking-wide text-slate-500">Final</div>
              <div class="text-3xl font-black"><span id="finalScore">0</span>/<span id="finalTotal">5</span></div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script>
    // ONE quiz only
    const QUIZ = {
      title: "Teen Summit — Business Basics",
      questions: [
        {
          text: "What is a business?",
          choices: [
            "A way to trade goods or services for money (or value)",
            "A school subject you only study in college",
            "A hobby you do for free",
            "A job where you only do chores"
          ],
          correctIndex: 0
        },
        {
          text: "Which is the BEST example of a business for a middle schooler?",
          choices: [
            "Mowing lawns for neighbors and charging a price",
            "Doing homework for free every day",
            "Watching videos after school",
            "Borrowing money and never paying it back"
          ],
          correctIndex: 0
        },
        {
          text: "What does “profit” mean?",
          choices: [
            "Money left after costs are paid",
            "All the money you earn before paying costs",
            "A business license",
            "A fancy logo"
          ],
          correctIndex: 0
        },
        {
          text: "Which is a smart FIRST step to start a business?",
          choices: [
            "Find a problem to solve or a need people have",
            "Buy expensive supplies right away",
            "Skip asking customers what they want",
            "Set random prices each day"
          ],
          correctIndex: 0
        },
        {
          text: "A business is different from a job because…",
          choices: [
            "A business owner finds customers and sets prices",
            "A job never pays money",
            "A business is only online",
            "A job means you can’t learn skills"
          ],
          correctIndex: 0
        }
      ]
    };

    const $ = (id) => document.getElementById(id);

    // Host defaults to teensummit, optional ?host=classA
    const url = new URL(window.location.href);
    const host = (url.searchParams.get("host") || "teensummit").trim();

    // ClientId (stable) + TabId (per tab)
    function ensureId(storage, key) {
      let v = storage.getItem(key);
      if (!v) {
        v = (crypto.randomUUID ? crypto.randomUUID() : String(Math.random()).slice(2) + Date.now());
        storage.setItem(key, v);
      }
      return v;
    }
    const clientId = ensureId(localStorage, "teen_summit_client_id");
    const tabId = ensureId(sessionStorage, "teen_summit_tab_id");

    $("hostBadge").textContent = `Host: ${host}`;
    $("clientBadge").textContent = clientId.slice(0, 8);
    $("tabBadge").textContent = tabId.slice(0, 8);

    async function apiGetCounts(q, choiceCount) {
      const r = await fetch(`/api/stats?host=${encodeURIComponent(host)}&q=${q}&choiceCount=${choiceCount}`);
      if (!r.ok) throw new Error("GET failed");
      return r.json();
    }

    async function apiVote(q, choice, choiceCount) {
      const r = await fetch("/api/stats", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ host, q, choice, choiceCount, clientId, tabId })
      });
      if (!r.ok) throw new Error("POST failed");
      return r.json();
    }

    let currentQ = 0;
    let answers = Array.from({ length: QUIZ.questions.length }, () => null);
    let score = 0;

    let chart = null;
    let pollTimer = null;

    function computeScore() {
      score = 0;
      QUIZ.questions.forEach((q, i) => {
        if (answers[i] === q.correctIndex) score++;
      });
    }

    function answeredCount() {
      return answers.filter(v => v !== null).length;
    }

    function updateProgress() {
      const done = answeredCount();
      const total = QUIZ.questions.length;
      $("answeredCount").textContent = String(done);
      $("answeredTotal").textContent = String(total);
      $("progressBar").style.width = `${Math.round((done / total) * 100)}%`;

      $("endSection").classList.toggle("hidden", done !== total);
      if (done === total) {
        $("finalScore").textContent = String(score);
        $("finalTotal").textContent = String(total);
      }
    }

    async function updateChartFromServer() {
      const q = QUIZ.questions[currentQ];
      const payload = await apiGetCounts(currentQ, q.choices.length);
      const counts = payload.counts;

      const labels = q.choices.map((_, i) => String.fromCharCode(65 + i));
      const ctx = $("countsChart").getContext("2d");

      if (!chart) {
        chart = new Chart(ctx, {
          type: "bar",
          data: { labels, datasets: [{ label: "Answers", data: counts }] },
          options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
          }
        });
      } else {
        chart.data.labels = labels;
        chart.data.datasets[0].data = counts;
        chart.update();
      }
    }

    function startPolling() {
      stopPolling();
      if (!$("pollToggle").checked) return;
      pollTimer = setInterval(() => {
        updateChartFromServer().catch(() => {});
      }, 1200);
    }

    function stopPolling() {
      if (pollTimer) clearInterval(pollTimer);
      pollTimer = null;
    }

    $("pollToggle").addEventListener("change", () => {
      if ($("pollToggle").checked) startPolling();
      else stopPolling();
    });

    async function render() {
      const q = QUIZ.questions[currentQ];
      $("qIndex").textContent = String(currentQ + 1);
      $("qTotal").textContent = String(QUIZ.questions.length);
      $("qText").textContent = q.text;

      computeScore();
      $("score").textContent = String(score);
      $("scoreTotal").textContent = String(QUIZ.questions.length);

      $("prevBtn").disabled = currentQ === 0;
      $("nextBtn").textContent = (currentQ === QUIZ.questions.length - 1) ? "Finish" : "Next";
      $("nextBtn").disabled = answers[currentQ] === null;

      $("feedback").textContent = "";

      // answers
      const grid = $("answersGrid");
      grid.innerHTML = "";

      q.choices.forEach((text, idx) => {
        const selected = answers[currentQ] === idx;
        const btn = document.createElement("button");
        btn.className =
          "text-left rounded-2xl border p-4 shadow-sm hover:shadow transition " +
          (selected ? "bg-slate-900 text-white border-slate-900" : "bg-white border-slate-200 hover:bg-slate-50");

        btn.innerHTML = `
          <div class="flex items-start gap-3">
            <div class="mt-0.5 h-7 w-7 rounded-xl grid place-items-center text-sm font-black ${selected ? "bg-white text-slate-900" : "bg-slate-100 text-slate-900"}">
              ${String.fromCharCode(65 + idx)}
            </div>
            <div class="flex-1">
              <div class="font-semibold leading-snug">${text}</div>
              <div class="mt-1 text-xs ${selected ? "text-slate-200" : "text-slate-500"}">Tap to select</div>
            </div>
          </div>
        `;

        btn.addEventListener("click", () => selectAnswer(idx));
        grid.appendChild(btn);
      });

      updateProgress();

      // refresh counts + restart polling for this question
      await updateChartFromServer();
      startPolling();
    }

    async function selectAnswer(choiceIdx) {
      const q = QUIZ.questions[currentQ];
      const wasUnanswered = (answers[currentQ] === null);

      answers[currentQ] = choiceIdx;

      // Only count once per question per identity
      if (wasUnanswered) {
        try {
          const result = await apiVote(currentQ, choiceIdx, q.choices.length);
          if (result.alreadyVoted) {
            $("feedback").textContent = "⚠️ This tab already voted on this question.";
            $("feedback").className = "text-sm font-semibold text-amber-700";
          } else {
            $("feedback").textContent = (choiceIdx === q.correctIndex) ? "✅ Correct!" : "❌ Not quite.";
            $("feedback").className = "text-sm font-semibold " + ((choiceIdx === q.correctIndex) ? "text-emerald-700" : "text-rose-700");
          }
        } catch {
          $("feedback").textContent = "⚠️ Vote failed (API not available).";
          $("feedback").className = "text-sm font-semibold text-amber-700";
        }
      }

      await render();
    }

    $("prevBtn").addEventListener("click", async () => {
      currentQ = Math.max(0, currentQ - 1);
      await render();
    });

    $("nextBtn").addEventListener("click", async () => {
      if (answers[currentQ] === null) return;

      if (currentQ === QUIZ.questions.length - 1) {
        // finish
        await render();
        return;
      }
      currentQ++;
      await render();
    });

    // boot
    render().catch(() => {
      $("feedback").textContent = "⚠️ Could not load shared counts. Make sure /api/stats works + KV is configured.";
      $("feedback").className = "text-sm font-semibold text-amber-700";
    });
  </script>
</body>
</html>
