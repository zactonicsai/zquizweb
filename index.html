<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Teen Summit â€” Business Basics</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,700;0,9..40,800;1,9..40,400&family=Bricolage+Grotesque:opsz,wght@12..96,700;12..96,800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    /* â•â•â•â•â•â•â• LIGHT THEME (default) â•â•â•â•â•â•â• */
    :root {
      --bg-primary: #f5f0eb;
      --bg-secondary: #ffffff;
      --bg-tertiary: #ede7e0;
      --bg-card-hover: #faf7f4;
      --text-primary: #1a1612;
      --text-secondary: #6b5e52;
      --text-muted: #9a8d82;
      --border: #ddd5cc;
      --accent: #e85d2a;
      --accent-soft: #fdeee8;
      --accent-hover: #d14e1f;
      --correct: #1a9956;
      --correct-soft: #e6f5ed;
      --wrong: #d93636;
      --wrong-soft: #fce8e8;
      --warn: #c48a12;
      --chart-a: #e85d2a;
      --chart-b: #3b7ddd;
      --chart-c: #1a9956;
      --chart-d: #9b59b6;
      --selected-bg: #1a1612;
      --selected-text: #ffffff;
      --selected-badge: #ffffff;
      --progress-track: #ddd5cc;
      --progress-fill: #e85d2a;
      --shadow-sm: 0 1px 3px rgba(26,22,18,0.06);
      --shadow-md: 0 4px 16px rgba(26,22,18,0.08);
      --radius: 16px;
      --radius-sm: 10px;
      --radius-xs: 6px;
      --transition: 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* â•â•â•â•â•â•â• DARK THEME â•â•â•â•â•â•â• */
    [data-theme="dark"] {
      --bg-primary: #111111;
      --bg-secondary: #1a1a1a;
      --bg-tertiary: #222222;
      --bg-card-hover: #252525;
      --text-primary: #f0ece8;
      --text-secondary: #a09890;
      --text-muted: #706860;
      --border: #2e2e2e;
      --accent: #f07040;
      --accent-soft: #2c1d15;
      --accent-hover: #ff8a60;
      --correct: #2dd47a;
      --wrong: #f05050;
      --warn: #e8a830;
      --chart-a: #f07040;
      --chart-b: #5a9eff;
      --chart-c: #2dd47a;
      --chart-d: #c084fc;
      --selected-bg: #f07040;
      --selected-text: #111111;
      --selected-badge: #111111;
      --progress-track: #2e2e2e;
      --progress-fill: #f07040;
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.3);
      --shadow-md: 0 4px 16px rgba(0,0,0,0.4);
    }

    html { scroll-behavior: smooth; }

    body {
      font-family: 'DM Sans', system-ui, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      transition: background var(--transition), color var(--transition);
      -webkit-font-smoothing: antialiased;
    }

    /* â”€â”€â”€ Header â”€â”€â”€ */
    header {
      position: sticky; top: 0; z-index: 20;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
      backdrop-filter: blur(12px);
      transition: background var(--transition), border-color var(--transition);
    }
    .header-inner {
      max-width: 1080px;
      margin: 0 auto;
      padding: 14px 20px;
      display: flex;
      align-items: center;
      gap: 14px;
    }
    .logo {
      width: 44px; height: 44px;
      border-radius: 14px;
      background: var(--accent);
      color: #fff;
      display: grid;
      place-items: center;
      font-family: 'Bricolage Grotesque', sans-serif;
      font-weight: 800;
      font-size: 16px;
      letter-spacing: -0.5px;
      flex-shrink: 0;
    }
    .header-text { flex: 1; min-width: 0; }
    .header-title {
      font-family: 'Bricolage Grotesque', sans-serif;
      font-size: 1.15rem;
      font-weight: 800;
      line-height: 1.2;
      letter-spacing: -0.3px;
    }
    .header-sub {
      font-size: 0.8rem;
      color: var(--text-secondary);
      margin-top: 2px;
    }
    .host-badge {
      padding: 6px 14px;
      border-radius: 100px;
      background: var(--bg-tertiary);
      color: var(--text-secondary);
      font-size: 0.78rem;
      font-weight: 600;
      white-space: nowrap;
      transition: background var(--transition), color var(--transition);
    }
    .theme-toggle {
      width: 40px; height: 40px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--bg-tertiary);
      color: var(--text-primary);
      cursor: pointer;
      display: grid;
      place-items: center;
      font-size: 18px;
      transition: all var(--transition);
      flex-shrink: 0;
    }
    .theme-toggle:hover {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
      transform: rotate(15deg);
    }

    /* â”€â”€â”€ Main Grid â”€â”€â”€ */
    main {
      max-width: 1080px;
      margin: 0 auto;
      padding: 24px 20px 40px;
    }
    .grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 20px;
    }
    @media (min-width: 960px) {
      .grid { grid-template-columns: 3fr 2fr; }
    }

    /* â”€â”€â”€ Cards â”€â”€â”€ */
    .card {
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: var(--bg-secondary);
      padding: 24px;
      box-shadow: var(--shadow-sm);
      transition: background var(--transition), border-color var(--transition), box-shadow var(--transition);
    }

    /* â”€â”€â”€ Question Panel â”€â”€â”€ */
    .q-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 16px; }
    .q-label {
      font-size: 0.7rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      color: var(--accent);
    }
    .q-text {
      font-family: 'Bricolage Grotesque', sans-serif;
      font-size: 1.35rem;
      font-weight: 800;
      line-height: 1.3;
      letter-spacing: -0.3px;
      margin-top: 6px;
    }
    .score-box { text-align: right; flex-shrink: 0; }
    .score-label {
      font-size: 0.65rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      color: var(--text-muted);
    }
    .score-value {
      font-family: 'Bricolage Grotesque', sans-serif;
      font-size: 1.8rem;
      font-weight: 800;
      line-height: 1;
      letter-spacing: -1px;
    }

    /* â”€â”€â”€ Answer Grid â”€â”€â”€ */
    .answers-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
      margin-top: 20px;
    }
    @media (min-width: 560px) {
      .answers-grid { grid-template-columns: 1fr 1fr; }
    }
    .answer-btn {
      text-align: left;
      border-radius: var(--radius-sm);
      border: 2px solid var(--border);
      background: var(--bg-secondary);
      padding: 16px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: flex-start;
      gap: 12px;
      position: relative;
      overflow: hidden;
      font-family: inherit;
      color: var(--text-primary);
    }
    .answer-btn::before {
      content: '';
      position: absolute;
      inset: 0;
      background: var(--accent);
      opacity: 0;
      transition: opacity 0.2s ease;
    }
    .answer-btn:hover {
      border-color: var(--accent);
      box-shadow: var(--shadow-md);
      transform: translateY(-1px);
    }
    .answer-btn:hover::before { opacity: 0.04; }
    .answer-btn:active { transform: translateY(0); }

    .answer-btn.selected {
      background: var(--selected-bg);
      border-color: var(--selected-bg);
      color: var(--selected-text);
      box-shadow: var(--shadow-md);
    }
    .answer-btn.selected::before { opacity: 0; }
    .answer-btn.selected .answer-badge {
      background: var(--selected-badge) !important;
      color: var(--selected-bg) !important;
    }
    .answer-btn.selected .answer-hint { opacity: 0.5; }

    .answer-badge {
      width: 32px; height: 32px;
      border-radius: 10px;
      display: grid;
      place-items: center;
      font-weight: 800;
      font-size: 0.85rem;
      flex-shrink: 0;
      transition: all 0.2s ease;
    }
    .badge-a { background: rgba(232,93,42,0.12); color: var(--chart-a); }
    .badge-b { background: rgba(59,125,221,0.12); color: var(--chart-b); }
    .badge-c { background: rgba(26,153,86,0.12); color: var(--chart-c); }
    .badge-d { background: rgba(155,89,182,0.12); color: var(--chart-d); }

    .answer-text { font-weight: 600; line-height: 1.4; font-size: 0.92rem; position: relative; }
    .answer-hint { font-size: 0.72rem; color: var(--text-muted); margin-top: 3px; transition: all 0.2s; position: relative; }

    /* â”€â”€â”€ Footer Row â”€â”€â”€ */
    .q-footer {
      margin-top: 20px;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    .feedback {
      font-size: 0.88rem;
      font-weight: 700;
      min-height: 24px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .feedback.correct { color: var(--correct); }
    .feedback.wrong { color: var(--wrong); }
    .feedback.warn { color: var(--warn); }

    .nav-btns { display: flex; gap: 8px; }
    .nav-btn {
      padding: 10px 20px;
      border-radius: var(--radius-sm);
      border: 2px solid var(--border);
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-weight: 700;
      font-size: 0.88rem;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: inherit;
    }
    .nav-btn:hover:not(:disabled) {
      border-color: var(--text-primary);
      box-shadow: var(--shadow-sm);
    }
    .nav-btn:disabled { opacity: 0.35; cursor: not-allowed; }
    .nav-btn.primary {
      background: var(--accent);
      border-color: var(--accent);
      color: #fff;
    }
    .nav-btn.primary:hover:not(:disabled) {
      background: var(--accent-hover);
      border-color: var(--accent-hover);
    }

    /* â”€â”€â”€ Sidebar â”€â”€â”€ */
    .sidebar-stack { display: flex; flex-direction: column; gap: 20px; }
    .chart-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 12px; }
    .chart-label {
      font-size: 0.65rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      color: var(--text-muted);
    }
    .chart-title {
      font-family: 'Bricolage Grotesque', sans-serif;
      font-size: 1.05rem;
      font-weight: 800;
      margin-top: 2px;
    }
    .auto-toggle {
      display: flex; align-items: center; gap: 8px;
      font-size: 0.75rem; font-weight: 600; color: var(--text-secondary);
      cursor: pointer; user-select: none;
    }
    .auto-toggle input[type="checkbox"] {
      width: 16px; height: 16px;
      accent-color: var(--accent);
    }
    .chart-wrap {
      margin-top: 16px;
      position: relative;
    }
    .chart-wrap canvas { border-radius: var(--radius-xs); }

    /* â”€â”€â”€ Progress Card â”€â”€â”€ */
    .progress-card {
      border-radius: var(--radius-sm);
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      padding: 18px;
      transition: background var(--transition), border-color var(--transition);
    }
    .progress-label {
      font-size: 0.65rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      color: var(--text-muted);
    }
    .progress-track {
      margin-top: 10px;
      height: 8px;
      border-radius: 100px;
      background: var(--progress-track);
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      width: 0%;
      border-radius: 100px;
      background: var(--progress-fill);
      transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .progress-info {
      margin-top: 10px;
      font-size: 0.85rem;
      color: var(--text-secondary);
    }
    .progress-info strong { color: var(--text-primary); font-weight: 700; }
    .progress-meta {
      margin-top: 8px;
      font-size: 0.72rem;
      color: var(--text-muted);
    }

    /* â”€â”€â”€ Finish Card â”€â”€â”€ */
    .finish-card {
      border: 2px solid var(--accent) !important;
      background: var(--accent-soft) !important;
      animation: pop-in 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    .finish-inner {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
    }
    .finish-title {
      font-family: 'Bricolage Grotesque', sans-serif;
      font-size: 1.4rem;
      font-weight: 800;
    }
    .finish-sub { color: var(--text-secondary); font-size: 0.9rem; margin-top: 2px; }
    .finish-score {
      font-family: 'Bricolage Grotesque', sans-serif;
      font-size: 2.4rem;
      font-weight: 800;
      color: var(--accent);
      letter-spacing: -1px;
      line-height: 1;
    }
    .finish-score-label {
      font-size: 0.65rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      color: var(--text-muted);
      text-align: right;
    }

    @keyframes pop-in {
      0% { transform: scale(0.92); opacity: 0; }
      100% { transform: scale(1); opacity: 1; }
    }

    /* â”€â”€â”€ Step Dots â”€â”€â”€ */
    .step-dots {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-top: 16px;
    }
    .step-dot {
      width: 10px; height: 10px;
      border-radius: 100px;
      background: var(--progress-track);
      transition: all 0.3s ease;
      cursor: pointer;
      border: none;
    }
    .step-dot.active {
      width: 28px;
      background: var(--accent);
    }
    .step-dot.answered { background: var(--correct); }
    .step-dot.answered.active {
      background: var(--accent);
      width: 28px;
    }

    /* â”€â”€â”€ Confetti â”€â”€â”€ */
    .confetti-container {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      pointer-events: none;
      z-index: 100;
      overflow: hidden;
    }
    .confetti-piece {
      position: absolute;
      width: 10px; height: 10px;
      top: -20px;
      animation: confetti-fall 3s ease-in forwards;
    }
    @keyframes confetti-fall {
      0% { transform: translateY(0) rotate(0deg); opacity: 1; }
      100% { transform: translateY(110vh) rotate(720deg); opacity: 0; }
    }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }

    @media (max-width: 600px) {
      .header-inner { padding: 12px 16px; }
      .host-badge { display: none; }
      main { padding: 16px 16px 32px; }
      .q-text { font-size: 1.15rem; }
      .card { padding: 18px; }
    }
  </style>
</head>
<body>

  <header>
    <div class="header-inner">
      <div class="logo">TS</div>
      <div class="header-text">
        <div class="header-title">Teen Summit â€” Business Basics</div>
        <div class="header-sub">5 questions Â· Live shared results</div>
      </div>
      <span id="hostBadge" class="host-badge">Host: â€”</span>
      <button id="themeBtn" class="theme-toggle" title="Toggle light/dark mode" aria-label="Toggle theme">â˜€ï¸</button>
    </div>
  </header>

  <main>
    <div class="grid">
      <!-- Question Panel -->
      <div class="card" id="questionCard">
        <div class="q-header">
          <div>
            <div class="q-label">Question <span id="qIndex">1</span> of <span id="qTotal">5</span></div>
            <h2 id="qText" class="q-text">â€”</h2>
          </div>
          <div class="score-box">
            <div class="score-label">Score</div>
            <div class="score-value"><span id="score">0</span>/<span id="scoreTotal">5</span></div>
          </div>
        </div>

        <div id="answersGrid" class="answers-grid"></div>

        <div class="step-dots" id="stepDots"></div>

        <div class="q-footer">
          <div id="feedback" class="feedback"></div>
          <div class="nav-btns">
            <button id="prevBtn" class="nav-btn" disabled>â† Back</button>
            <button id="nextBtn" class="nav-btn primary" disabled>Next â†’</button>
          </div>
        </div>
      </div>

      <!-- Sidebar -->
      <div class="sidebar-stack">
        <div class="card">
          <div class="chart-header">
            <div>
              <div class="chart-label">Live Results</div>
              <div class="chart-title">Answer Distribution</div>
            </div>
            <label class="auto-toggle">
              <input id="pollToggle" type="checkbox" checked />
              Auto-update
            </label>
          </div>
          <div class="chart-wrap">
            <canvas id="countsChart" height="200"></canvas>
          </div>
        </div>

        <div class="progress-card">
          <div class="progress-label">Your Progress</div>
          <div class="progress-track">
            <div id="progressBar" class="progress-fill"></div>
          </div>
          <div class="progress-info">
            Answered: <strong><span id="answeredCount">0</span></strong> / <strong><span id="answeredTotal">5</span></strong>
          </div>
          <div class="progress-meta">
            ID: <span id="clientBadge"></span> Â· Tab: <span id="tabBadge"></span>
          </div>
        </div>

        <div id="endSection" class="card finish-card" style="display:none;">
          <div class="finish-inner">
            <div>
              <div class="finish-title">ğŸ‰ Finished!</div>
              <div class="finish-sub">Great work â€” quiz complete.</div>
            </div>
            <div>
              <div class="finish-score-label">Final Score</div>
              <div class="finish-score"><span id="finalScore">0</span>/<span id="finalTotal">5</span></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       THEME TOGGLE
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    const themeBtn = document.getElementById('themeBtn');
    const savedTheme = localStorage.getItem('ts_theme');
    if (savedTheme === 'dark') {
      document.documentElement.setAttribute('data-theme', 'dark');
      themeBtn.textContent = 'ğŸŒ™';
    }
    themeBtn.addEventListener('click', () => {
      const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
      if (isDark) {
        document.documentElement.removeAttribute('data-theme');
        themeBtn.textContent = 'â˜€ï¸';
        localStorage.setItem('ts_theme', 'light');
      } else {
        document.documentElement.setAttribute('data-theme', 'dark');
        themeBtn.textContent = 'ğŸŒ™';
        localStorage.setItem('ts_theme', 'dark');
      }
      if (chart) updateChartTheme();
    });

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       QUIZ DATA
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    const QUIZ = {
      title: "Teen Summit \u2014 Business Basics",
      questions: [
        {
          text: "What is a business?",
          choices: [
            "A way to trade goods or services for money (or value)",
            "A school subject you only study in college",
            "A hobby you do for free",
            "A job where you only do chores"
          ],
          correctIndex: 0
        },
        {
          text: "Which is the BEST example of a business for a middle schooler?",
          choices: [
            "Mowing lawns for neighbors and charging a price",
            "Doing homework for free every day",
            "Watching videos after school",
            "Borrowing money and never paying it back"
          ],
          correctIndex: 0
        },
        {
          text: "What does \u201Cprofit\u201D mean?",
          choices: [
            "Money left after costs are paid",
            "All the money you earn before paying costs",
            "A business license",
            "A fancy logo"
          ],
          correctIndex: 0
        },
        {
          text: "Which is a smart FIRST step to start a business?",
          choices: [
            "Find a problem to solve or a need people have",
            "Buy expensive supplies right away",
            "Skip asking customers what they want",
            "Set random prices each day"
          ],
          correctIndex: 0
        },
        {
          text: "A business is different from a job because\u2026",
          choices: [
            "A business owner finds customers and sets prices",
            "A job never pays money",
            "A business is only online",
            "A job means you can\u2019t learn skills"
          ],
          correctIndex: 0
        }
      ]
    };

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       UTILS & STATE
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    const $ = (id) => document.getElementById(id);

    const pageUrl = new URL(window.location.href);
    const host = (pageUrl.searchParams.get("host") || "teensummit").trim();

    function ensureId(storage, key) {
      let v = storage.getItem(key);
      if (!v) {
        v = crypto.randomUUID ? crypto.randomUUID() : String(Math.random()).slice(2) + Date.now();
        storage.setItem(key, v);
      }
      return v;
    }
    const clientId = ensureId(localStorage, "teen_summit_client_id");
    const tabId    = ensureId(sessionStorage, "teen_summit_tab_id");

    $("hostBadge").textContent  = "Host: " + host;
    $("clientBadge").textContent = clientId.slice(0, 8);
    $("tabBadge").textContent    = tabId.slice(0, 8);

    let currentQ  = 0;
    let answers   = Array.from({ length: QUIZ.questions.length }, () => null);
    let score     = 0;
    let chart     = null;
    let pollTimer = null;

    const CHART_VAR_NAMES = ['--chart-a', '--chart-b', '--chart-c', '--chart-d'];
    const BADGE_CLASSES   = ['badge-a', 'badge-b', 'badge-c', 'badge-d'];

    function css(v) {
      return getComputedStyle(document.documentElement).getPropertyValue(v).trim();
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       API CALLS
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    async function apiGetCounts(q, choiceCount) {
      const r = await fetch("/api/stats?host=" + encodeURIComponent(host) + "&q=" + q + "&choiceCount=" + choiceCount);
      if (!r.ok) throw new Error("GET failed");
      return r.json();
    }

    async function apiVote(q, choice, choiceCount) {
      const r = await fetch("/api/stats", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ host, q, choice, choiceCount, clientId, tabId })
      });
      if (!r.ok) throw new Error("POST failed");
      return r.json();
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SCORING & PROGRESS
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    function computeScore() {
      score = 0;
      QUIZ.questions.forEach((q, i) => {
        if (answers[i] === q.correctIndex) score++;
      });
    }

    function answeredCount() {
      return answers.filter(v => v !== null).length;
    }

    function updateProgress() {
      const done  = answeredCount();
      const total = QUIZ.questions.length;
      $("answeredCount").textContent = String(done);
      $("answeredTotal").textContent = String(total);
      $("progressBar").style.width   = Math.round((done / total) * 100) + "%";

      if (done === total) {
        $("endSection").style.display = '';
        $("finalScore").textContent   = String(score);
        $("finalTotal").textContent   = String(total);
        fireConfetti();
      } else {
        $("endSection").style.display = 'none';
      }
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       STEP DOTS
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    function renderStepDots() {
      const el = $("stepDots");
      el.innerHTML = "";
      QUIZ.questions.forEach((_, i) => {
        const dot = document.createElement("button");
        dot.className = "step-dot";
        if (i === currentQ)      dot.classList.add("active");
        if (answers[i] !== null) dot.classList.add("answered");
        dot.addEventListener("click", async () => { currentQ = i; await render(); });
        el.appendChild(dot);
      });
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       CHART
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    function chartColors() { return CHART_VAR_NAMES.map(css); }

    function updateChartTheme() {
      if (!chart) return;
      const colors = chartColors();
      chart.data.datasets[0].backgroundColor      = colors;
      chart.data.datasets[0].borderColor           = colors;
      chart.data.datasets[0].hoverBackgroundColor   = colors;
      chart.options.scales.x.ticks.color = css('--text-secondary');
      chart.options.scales.y.ticks.color = css('--text-secondary');
      chart.options.scales.y.grid.color  = css('--border');
      chart.update('none');
    }

    async function updateChartFromServer() {
      const q       = QUIZ.questions[currentQ];
      const payload = await apiGetCounts(currentQ, q.choices.length);
      const counts  = payload.counts;
      const labels  = q.choices.map((_, i) => String.fromCharCode(65 + i));
      const colors  = chartColors();

      if (!chart) {
        chart = new Chart($("countsChart").getContext("2d"), {
          type: "bar",
          data: {
            labels,
            datasets: [{
              label: "Answers",
              data: counts,
              backgroundColor: colors,
              borderColor: colors,
              hoverBackgroundColor: colors,
              borderWidth: 0,
              borderRadius: 8,
              borderSkipped: false,
              barPercentage: 0.65,
              categoryPercentage: 0.7
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            animation: { duration: 500, easing: 'easeOutQuart' },
            plugins: {
              legend: { display: false },
              tooltip: {
                backgroundColor: css('--bg-secondary'),
                titleColor: css('--text-primary'),
                bodyColor: css('--text-primary'),
                borderColor: css('--border'),
                borderWidth: 1,
                cornerRadius: 8,
                padding: 10,
                displayColors: true,
                callbacks: {
                  label: function(ctx) { return " " + ctx.parsed.y + " vote" + (ctx.parsed.y !== 1 ? "s" : ""); }
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: { precision: 0, color: css('--text-secondary'), font: { size: 11, weight: '600' } },
                grid: { color: css('--border'), drawBorder: false },
                border: { display: false }
              },
              x: {
                ticks: { color: css('--text-secondary'), font: { size: 13, weight: '700' } },
                grid: { display: false },
                border: { display: false }
              }
            }
          }
        });
      } else {
        chart.data.labels = labels;
        chart.data.datasets[0].data = counts;
        chart.data.datasets[0].backgroundColor = colors;
        chart.data.datasets[0].borderColor = colors;
        chart.update();
      }
    }

    function startPolling() {
      stopPolling();
      if (!$("pollToggle").checked) return;
      pollTimer = setInterval(() => { updateChartFromServer().catch(() => {}); }, 1200);
    }
    function stopPolling() {
      if (pollTimer) clearInterval(pollTimer);
      pollTimer = null;
    }
    $("pollToggle").addEventListener("change", () => {
      $("pollToggle").checked ? startPolling() : stopPolling();
    });

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       CONFETTI
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    let confettiFired = false;
    function fireConfetti() {
      if (confettiFired) return;
      confettiFired = true;
      const container = document.createElement('div');
      container.className = 'confetti-container';
      document.body.appendChild(container);
      const palette = ['#e85d2a','#3b7ddd','#1a9956','#9b59b6','#f1c40f','#e74c3c'];
      for (let i = 0; i < 60; i++) {
        const p = document.createElement('div');
        p.className = 'confetti-piece';
        p.style.left            = Math.random() * 100 + '%';
        p.style.background      = palette[Math.floor(Math.random() * palette.length)];
        p.style.animationDelay  = Math.random() * 1.5 + 's';
        p.style.animationDuration = (2 + Math.random() * 2) + 's';
        p.style.borderRadius    = Math.random() > 0.5 ? '50%' : '2px';
        p.style.width           = (6 + Math.random() * 8) + 'px';
        p.style.height          = (6 + Math.random() * 8) + 'px';
        container.appendChild(p);
      }
      setTimeout(() => container.remove(), 5000);
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       RENDER
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    async function render() {
      const q = QUIZ.questions[currentQ];
      $("qIndex").textContent    = String(currentQ + 1);
      $("qTotal").textContent    = String(QUIZ.questions.length);
      $("qText").textContent     = q.text;

      computeScore();
      $("score").textContent     = String(score);
      $("scoreTotal").textContent = String(QUIZ.questions.length);

      $("prevBtn").disabled  = currentQ === 0;
      $("nextBtn").textContent = currentQ === QUIZ.questions.length - 1 ? "Finish âœ“" : "Next â†’";
      $("nextBtn").disabled  = answers[currentQ] === null;

      $("feedback").textContent = "";
      $("feedback").className   = "feedback";

      // Answer buttons
      const grid = $("answersGrid");
      grid.innerHTML = "";

      q.choices.forEach((text, idx) => {
        const selected = answers[currentQ] === idx;
        const btn = document.createElement("button");
        btn.className = "answer-btn" + (selected ? " selected" : "");
        btn.innerHTML =
          '<div class="answer-badge ' + (selected ? '' : (BADGE_CLASSES[idx] || '')) + '">' +
            String.fromCharCode(65 + idx) +
          '</div>' +
          '<div>' +
            '<div class="answer-text">' + text + '</div>' +
            '<div class="answer-hint">' + (selected ? 'Selected' : 'Tap to select') + '</div>' +
          '</div>';
        btn.addEventListener("click", () => selectAnswer(idx));
        grid.appendChild(btn);
      });

      renderStepDots();
      updateProgress();
      await updateChartFromServer();
      startPolling();
    }

    async function selectAnswer(choiceIdx) {
      const q = QUIZ.questions[currentQ];
      const wasUnanswered = answers[currentQ] === null;
      answers[currentQ] = choiceIdx;

      if (wasUnanswered) {
        try {
          const result = await apiVote(currentQ, choiceIdx, q.choices.length);
          if (result.alreadyVoted) {
            $("feedback").textContent = "\u26A0\uFE0F This tab already voted on this question.";
            $("feedback").className   = "feedback warn";
          } else {
            const ok = choiceIdx === q.correctIndex;
            $("feedback").textContent = ok ? "\u2705 Correct!" : "\u274C Not quite.";
            $("feedback").className   = "feedback " + (ok ? "correct" : "wrong");
          }
        } catch {
          $("feedback").textContent = "\u26A0\uFE0F Vote failed \u2014 API not available.";
          $("feedback").className   = "feedback warn";
        }
      }
      await render();
    }

    $("prevBtn").addEventListener("click", async () => {
      currentQ = Math.max(0, currentQ - 1);
      await render();
    });

    $("nextBtn").addEventListener("click", async () => {
      if (answers[currentQ] === null) return;
      if (currentQ < QUIZ.questions.length - 1) currentQ++;
      await render();
    });

    // Boot
    render().catch(() => {
      $("feedback").textContent = "\u26A0\uFE0F Could not load shared counts. Make sure /api/stats works + KV is configured.";
      $("feedback").className   = "feedback warn";
    });
  </script>

</body>
</html>